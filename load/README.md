# Слой загрузки — хранение в MongoDB

## Обзор

Все трансформированные экономические данные хранятся в единой коллекции MongoDB `diploma.economic_indicators`. MongoDB выбрана потому что данные гетерогенны (4 индикатора из 4 источников с разной гранулярностью и покрытием), и гибкая документная модель подходит лучше жёсткой реляционной схемы.

## Схема коллекции

```
diploma.economic_indicators
```

| Поле            | Тип       | Nullable | Описание                                             |
|-----------------|-----------|----------|------------------------------------------------------|
| country_code    | string    | нет      | ISO 3166-1 alpha-3 (напр. `USA`, `DEU`, `KOR`)      |
| country_name    | string    | да       | Человекочитаемое название страны                     |
| year            | int       | нет      | Календарный год                                      |
| value           | double    | нет      | Исходное значение из источника, не модифицируется    |
| value_rebased   | double    | да       | Перебазировано к 2015=100 (`null` если нет данных за 2015) |
| indicator_type  | string    | нет      | Один из 4 типов индикаторов (см. ниже)               |
| source          | string    | нет      | Идентификатор источника данных                       |
| ingested_at     | timestamp | нет      | UTC-время запуска ETL-пайплайна                      |

Пример документа:
```json
{
  "country_code": "USA",
  "country_name": "United States",
  "year": 2020,
  "indicator_type": "cpi",
  "value": 118.69,
  "value_rebased": 109.2,
  "source": "worldbank",
  "ingested_at": "2026-02-14T01:11:40.894Z"
}
```

## Индикаторы

| indicator_type        | Источник  | Единица измерения          | Стран | Годы        |
|-----------------------|-----------|----------------------------|-------|-------------|
| `cpi`                 | WorldBank | Индекс (исх. 2010=100)     | 192   | 1980–2024   |
| `food_cpi`            | FAOSTAT   | Индекс (исх. 2015=100)     | 165   | 2000–2025   |
| `hourly_wage`         | ILOSTAT   | Локальная валюта / час      | 128   | 1997–2024   |
| `housing_price_index` | BIS       | Индекс (исх. 2010=100)     | 58    | 1980–2025   |

## Два столбца значений

- **`value`** — исходное значение из источника, без изменений. Для индексов это база самого источника (WorldBank CPI: 2010=100, FAOSTAT: 2015=100, BIS HPI: 2010=100). Для зарплат — номинальная величина в локальной валюте (ILO, за час).
- **`value_rebased`** — все индикаторы перебазированы к **2015=100** по формуле `value / value_2015 * 100`. Это позволяет сравнивать динамику роста между странами и индикаторами на единой шкале. Если у страны+индикатора нет данных за 2015 год, `value_rebased = null`.

## Индексы

| Индекс                                 | Тип      | Назначение                                        |
|----------------------------------------|----------|---------------------------------------------------|
| `(country_code, year, indicator_type)` | unique   | Запрет дубликатов; быстрый поиск по стране+году   |
| `(indicator_type, year)`               | обычный  | Временные ряды по индикатору через все страны      |
| `(country_code)`                       | обычный  | Все индикаторы по одной стране                    |

Индексы определены в `init_mongo.js` и пересоздаются Spark ETL после каждой записи в режиме `overwrite` (Spark дропает коллекцию).

## Зачем это нужно для визуализации

Структура хранения напрямую поддерживает требования фронтенд-дашборда:

1. **Сравнение стран** — уникальный индекс по `(country_code, year, indicator_type)` означает, что один запрос с фильтром по `indicator_type` и списку стран возвращает ровно те данные, которые нужны для multi-line графика временного ряда. Дедупликация на фронте не нужна.

2. **Динамика роста** — `value_rebased` (2015=100 для всех индикаторов) позволяет отображать CPI, зарплаты и цены на жильё на одной оси Y. Можно увидеть, обгоняют ли зарплаты инфляцию или стоимость жилья в конкретной стране.

3. **Динамика зарплат** — `value_rebased` для `hourly_wage` показывает рост номинальных зарплат относительно 2015=100. Сравнивая с CPI на том же графике, видно, растут ли реальные зарплаты.

4. **Смешанные дашборды** — все 4 индикатора хранятся в одной коллекции с единой схемой, поэтому один запрос `{country_code: "USA"}` возвращает CPI, продуктовый CPI, зарплаты и жильё вместе, без джойнов нескольких коллекций.

5. **Обработка разреженных данных** — `value_rebased: null` явно сигнализирует фронту, что у страны нет базового значения за 2015 год. UI может показать «нет данных» вместо вводящего в заблуждение нуля.
